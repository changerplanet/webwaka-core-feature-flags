
WebWaka Modular Rebuild

Phase 3F-3 ‚Äî Core Feature Flags & Experiments Implementation

‚∏ª

CONTEXT (READ CAREFULLY)

You are implementing Phase 3F-3 of the WebWaka Modular Rebuild.

This task is governed by the WebWaka Ecosystem Constitution (v1.3.1+) and the LOCKED Phase 3F-2 Formal Specification.

This is a core, headless TypeScript library.

üö´ DO NOT build UI
üö´ DO NOT add persistence
üö´ DO NOT add analytics or tracking
üö´ DO NOT add background jobs
üö´ DO NOT add dashboards
üö´ DO NOT integrate external services

Your responsibility is to implement the pure, deterministic Feature Flags & Experiments engine exactly as specified.

‚∏ª

SOURCE OF TRUTH

GitHub Repo (already exists):
https://github.com/changerplanet/webwaka-core-feature-flags

Work directly on main branch
Branch protection is disabled
You MAY push directly to main

Registry exists and will validate your manifest.

‚∏ª

TECH STACK (LOCKED)
	‚Ä¢	Language: TypeScript
	‚Ä¢	Runtime: Library only (no server)
	‚Ä¢	Validation: Zod
	‚Ä¢	Hashing: SHA-256
	‚Ä¢	Tests: Vitest or Jest
	‚Ä¢	Coverage requirement: ‚â•80%

‚∏ª

OBJECTIVE

Implement the Core Feature Flags & Experiments engine with:
	‚Ä¢	Deterministic feature gating
	‚Ä¢	Deterministic experiment bucketing
	‚Ä¢	Full precedence enforcement
	‚Ä¢	Offline-safe snapshots
	‚Ä¢	Snapshot integrity verification
	‚Ä¢	Strict tenant isolation

‚∏ª

IMPLEMENTATION SCOPE (EXACT)

1Ô∏è‚É£ DOMAIN MODELS (Zod-validated)

You MUST implement:
	‚Ä¢	FeatureFlagDefinition
	‚Ä¢	FeatureRule
	‚Ä¢	ExperimentDefinition
	‚Ä¢	EvaluationContext
	‚Ä¢	FeatureSnapshot
	‚Ä¢	ExperimentAssignment

All models must:
	‚Ä¢	Be immutable by design
	‚Ä¢	Reject invalid time windows
	‚Ä¢	Enforce tenantId presence

‚∏ª

2Ô∏è‚É£ PRECEDENCE HIERARCHY (NON-NEGOTIABLE)

Evaluation MUST respect this exact order:
	1.	Individual overrides
	2.	Group overrides
	3.	Tenant-level rules
	4.	Partner-level rules
	5.	Plan-level rules
	6.	System defaults

‚û°Ô∏è First matching rule wins
‚û°Ô∏è Lower layers MUST NOT override higher layers

‚∏ª

3Ô∏è‚É£ FEATURE FLAG EVALUATION ENGINE

Implement:

checkFeature(
  featureId: string,
  context: EvaluationContext,
  rules: FeatureRule[]
): FeatureEvaluationResult

Rules:
	‚Ä¢	Deterministic
	‚Ä¢	Explainable (must return reason + source)
	‚Ä¢	Time-aware
	‚Ä¢	Tenant-isolated

‚∏ª

4Ô∏è‚É£ EXPERIMENT BUCKETING (LOCKED ALGORITHM)

Variant assignment MUST be computed as:

hash = SHA256(experimentId + subjectId + tenantId + salt)
bucket = hash % 100

Mapping MUST respect trafficAllocation percentages.

‚ùå No randomness
‚ùå No time dependency
‚ùå No environment dependency

Same inputs ‚Üí same variant ALWAYS.

‚∏ª

5Ô∏è‚É£ SNAPSHOT SYSTEM (MANDATORY)

Implement:

generateFeatureSnapshot(context, rules, experiments)
verifySnapshot(snapshot)
evaluateFromSnapshot(featureId, snapshot, now)

Snapshot MUST:
	‚Ä¢	Be offline-safe
	‚Ä¢	Include checksum (SHA-256 canonical JSON)
	‚Ä¢	Detect tampering
	‚Ä¢	Respect expiry
	‚Ä¢	Be deterministic

‚∏ª

6Ô∏è‚É£ TENANT ISOLATION (HARD RULE)
	‚Ä¢	All APIs REQUIRE tenantId
	‚Ä¢	Cross-tenant evaluation MUST throw
	‚Ä¢	Snapshots MUST embed tenant hash
	‚Ä¢	No silent fallbacks

‚∏ª

7Ô∏è‚É£ PUBLIC APIs (REQUIRED)

You MUST expose exactly:

checkFeature()
assignExperimentVariant()
generateFeatureSnapshot()
verifySnapshot()
evaluateFromSnapshot()


‚∏ª

8Ô∏è‚É£ CAPABILITIES REGISTRATION

Update module.manifest.json to include:

[
  "feature:check",
  "experiment:assign",
  "feature:snapshot.generate",
  "feature:snapshot.verify",
  "experiment:snapshot.evaluate"
]


‚∏ª

HARD STOP CONDITION (MANDATORY TEST)

You MUST include a test that proves:

A Suite can evaluate a feature flag or experiment online or offline, for a given subject and tenant, and receive a deterministic, explainable, verifiable result, respecting precedence, time bounds, and tenant isolation.

If this test is missing ‚Üí ‚ùå phase NOT complete.

‚∏ª

TESTING REQUIREMENTS
	‚Ä¢	‚â•80% coverage
	‚Ä¢	Determinism proven by repeated evaluation (‚â•10x)
	‚Ä¢	Explicit tests for:
	‚Ä¢	Precedence order
	‚Ä¢	Tenant isolation
	‚Ä¢	Snapshot integrity
	‚Ä¢	Expired rules exclusion
	‚Ä¢	Bucketing stability

‚∏ª

EXPLICIT EXCLUSIONS (DO NOT IMPLEMENT)

‚ùå Analytics
‚ùå Tracking
‚ùå Metrics
‚ùå Persistence
‚ùå UI
‚ùå Dashboards
‚ùå Background jobs
‚ùå External APIs

‚∏ª

FINAL DELIVERABLE

When complete, provide:
	1.	Completion Summary
	2.	List of APIs implemented
	3.	Test coverage metrics
	4.	Hard Stop proof explanation
	5.	Final commit SHA

Then:

‚õî STOP
‚õî Await explicit authorization before proceeding further

‚∏ª

ACKNOWLEDGEMENT REQUIRED

Reply first with:

‚ÄúI acknowledge and will implement Phase 3F-3 exactly as specified.‚Äù

Then begin implementation.

‚∏ª